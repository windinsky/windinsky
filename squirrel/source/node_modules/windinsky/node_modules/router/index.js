// var Controller = require('controller');
var config = {};


var route = {
	rules:[],
	route: function(ctrl_path,view_path,req,res){

		var url = req.url.split('?')[0],m = null;

		for (var i = 0; i < route.rules.length; i++) {
			var rule = route.rules[i];
			var m = url.match(rule[0]);
			
			if (m === null) continue;

			var info = rule[1].apply(null,m.slice(1));
			var ctrl = info.controller || '',
				action = info.action || 'index',
				param = info.param || undefined;
			var ctrl_name = ctrl === '' ? ctrl_path.substr(0,ctrl_path.length-1) : (ctrl_path + ctrl);

			if (debug) {
				ctrl = require(ctrl_name);
			}else{
				try{
					ctrl = require(ctrl_name);
				}catch(e){
					console.log('controller "' + ctrl + '" is missing.');
					return res.redirect('404.html');
				}
			}
			if (!debug) {
				if (!ctrl || !ctrl[action]) {
					console.log('action "' + action + '" for controller "' + ctrl + '" is missing.');
					return res.redirect('404.html');
				};
			};
			
			ctrl[action](req,res);
			
			break;
		};
	},
	bind: function(regExp,fn){
		this.rules.push([regExp,fn]);
	},
	process: function(fn,req,res){
		return new Controller(fn)(req,res);
	},
	setApiPath: function(path){
		config.api = path;
	},
	setViewPath: function(path){
		config.view = path;
	},
	setViewEngine: function(engin){
		config.viewEngine = engin;
	}
}

module.exports = route;

route.bind(/^(\/)$/,function(){
	return {};
});

route.bind(/^\/([\w_]+)\/$/,function(ctrl){
	return {controller:ctrl};
});

route.bind(/^\/([\w_]+)\/([\w_]+)\/([\w_]+)\/$/,function(ctrl,action,params){
	return {
		controller:ctrl,
		action:action,
		param:param
	};
});

route.bind(/^\/([\w_]+)\/([\w_]+)\/$/,function(ctrl,action){
	return {
		controller:ctrl,
		action:action
	};
});