var http = require('http');
var utils = require('../utils');
module.exports = {
	_onFinish: function(key,data){
		try{
			this.data[key] = JSON.parse(data);
		}catch(e){
			this.data[key] = undefined;
		}
		
		this.count--;
		
		if (this.count === 0) {
			utils.extend(this.data,this.config.global);
			this.emit('end',this.data);
		};
	},
	_send: function(url,key){
		var self = this,
			url = url.split('::'),
			host = this.config.api.path[url[0]],
			path = "/windinsky.cgi";
			
		if (!host) {
			console.log('host ' + url[0] + ' is missing');
			this.count--;
			return ;
		};

		url = url[1];
		var req = http.request(
			{
				hostname:host,
				path:path,
				method: this.req.method,
				port:80
			},
			function(res){
				res.on('data',function(data){
					console.log(data.toString());
					self.emit('data',key,data.toString());
				});
			}
		);
		// console.log(IncomingMessage.prototype);
		req.setHeader("Cookie",this.req.headers['cookie'] || "");
		// console.log(url);
		req.setHeader("url",url);
		req.on('error',function(error){
			console.log('Request Error: | path:'+url+' | '+error);
			self.emit('error',key);
		});
		req.end();
	},
	send: function(interfaces){
		this.count = 0;
		this.on('data',this._onFinish);
		this.on('error',this._onFinish);
		for(var i in interfaces){
			this.count++;
			this._send(interfaces[i],i);
		}
	}
}